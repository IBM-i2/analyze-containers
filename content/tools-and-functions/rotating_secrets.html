<!DOCTYPE html>
<!--[if IE]><![endif]-->
<html>
  
  <head>
    <meta charset="utf-8">
    <meta http-equiv="X-UA-Compatible" content="IE=edge,chrome=1">
    <title>Rotating secrets </title>
    <meta name="viewport" content="width=device-width">
    <meta name="title" content="Rotating secrets ">
    <meta name="generator" content="docfx 2.56.2.0">
    
    <link rel="shortcut icon" href="../../images/favicon.png">
    <link rel="stylesheet" href="../../styles/docfx.vendor.css">
    <link rel="stylesheet" href="../../styles/docfx.css">
    <link rel="stylesheet" href="../../styles/main.css">
    <meta property="docfx:navrel" content="../../toc.html">
    <meta property="docfx:tocrel" content="../toc.html">
    
    <meta property="docfx:rel" content="../../">
    
  </head>
  <body data-spy="scroll" data-target="#affix" data-offset="120">
    <div id="wrapper">
      <header>
        
        <nav id="autocollapse" class="navbar navbar-inverse ng-scope" role="navigation">
          <div class="container">
            <div class="navbar-header">
              <button type="button" class="navbar-toggle" data-toggle="collapse" data-target="#navbar">
                <span class="sr-only">Toggle navigation</span>
                <span class="icon-bar"></span>
                <span class="icon-bar"></span>
                <span class="icon-bar"></span>
              </button>
              
              <a class="navbar-brand" href="../../index.html">
                i2 Analyze Deployment Tooling
              </a>
            </div>
            <div class="collapse navbar-collapse" id="navbar">
              <form class="navbar-form navbar-right" role="search" id="search">
                <div class="form-group">
                  <input type="text" class="form-control" id="search-query" placeholder="Search" autocomplete="off">
                </div>
              </form>
            </div>
          </div>
        </nav>
      </header>
      <div class="container body-content">
        
        <div id="search-results">
          <div class="search-list"></div>
          <div class="sr-items">
            <p><i class="glyphicon glyphicon-refresh index-loading"></i></p>
          </div>
          <ul id="pagination"></ul>
        </div>
      </div>
      <div role="main" class="container body-content hide-when-search">
        
        <div class="sidenav hide-when-search">
          <a class="btn toc-toggle collapse" data-toggle="collapse" href="#sidetoggle" aria-expanded="false" aria-controls="sidetoggle">Show / Hide Table of Contents</a>
          <div class="sidetoggle collapse" id="sidetoggle">
            <div id="sidetoc"></div>
          </div>
        </div>
        <div class="article row grid-right">
          <div class="col-md-10">
          
          <div class="subnav navbar navbar-default">
            <div class="container hide-when-search" id="breadcrumb">
              <ul class="breadcrumb">
                <li></li>
              </ul>
            </div>
          </div>
            <article class="content wrap" id="_content" data-uid="">
<h1 id="rotating-secrets">Rotating secrets</h1>

<p>The secrets that are used by the deployment might expire or otherwise need to be rotated. The following information describes how to rotate the secrets in a containerized environment.</p>
<p>The process for rotating secrets is as follows:</p>
<ul>
<li>Make a copy of the existing secrets.</li>
<li>Generate new secrets.</li>
<li>Update the secrets in the running containers.</li>
<li>Update the secrets in the environment variables and re-run the containers.</li>
</ul>
<h2 id="procedure">Procedure</h2>
<ol>
<li>Make a copy of the existing secrets directory or secrets.</li>
<li>Generate new secrets by running <code>utils/scripts/generate-secrets.sh</code>.</li>
<li>Remove the existing containers but keep all volumes.</li>
</ol>
<h2 id="solr-and-zookeeper">Solr and ZooKeeper</h2>
<ol>
<li><p>Run the Solr and ZooKeeper containers with the previous secrets that you made a copy of. To do this you can update the <code>docker run</code> command to specify the backup directory for the secrets to mount or update the values in the secret environment variables.</p>
<p> For example, the <code>docker run</code> command for ZooKeeper might look like:</p>
<pre><code class="lang-bash">docker run --restart always -d \
  --name &quot;zk1&quot; \
  --net &quot;eia&quot; \
  --net-alias &quot;zk1.eia&quot; \
  -p &quot;8080:8080&quot; \
  -p &quot;2181:2181&quot; \
  -p &quot;2281:2281&quot; \
  -p &quot;3888:3888&quot; \
  -p &quot;2888:2888&quot; \
  -v &quot;zk1_data:/data&quot; \
  -v &quot;zk1_datalog:/datalog&quot; \
  -v &quot;zk1_logs:/logs&quot; \
  -v &quot;/copy-of-secrets/simulated-secret-store/zk1:/run/secrets&quot; \
  -e &quot;ZOO_SERVERS=server.1=zk1.eia:2888:3888 server.2=zk2.eia:2888:3888 server.3=zk3.eia:2888:3888&quot; \
  -e &quot;ZOO_MY_ID=1&quot; \
  -e &quot;ZOO_SECURE_CLIENT_PORT=2281&quot; \
  -e &quot;ZOO_CLIENT_PORT=2181&quot; \
  -e &quot;ZOO_4LW_COMMANDS_WHITELIST=ruok, mntr, conf&quot; \
  -e &quot;SERVER_SSL=true&quot; \
  -e &quot;SSL_PRIVATE_KEY_FILE=/run/secrets/server.key&quot; \
  -e &quot;SSL_CERTIFICATE_FILE=/run/secrets/server.cer&quot; \
  -e &quot;SSL_CA_CERTIFICATE_FILE=/run/secrets/CA.cer&quot; \
  &quot;i2eng/i2eng-zookeeper:3.6&quot;
</code></pre><p> Where the <code>-v &quot;/copy-of-secrets/simulated-secret-store/zk1:/run/secrets&quot;</code> volume mount is the location of the backed up secrets.</p>
<p> For more information about running the containers, see <a href="../images-and-containers/solr.html#docker-run-command">Solr</a> and <a href="../images-and-containers/zookeeper.html#docker-run-command">ZooKeeper</a>.</p>
</li>
<li><p>Upload the new <code>security.json</code> file to Solr by using the <code>run_solr_client_command</code> function. For example:</p>
<pre><code class="lang-bash">run_solr_client_command bash -c &quot;echo \&quot;\${SECURITY_JSON}\&quot; &gt; /tmp/security.json &amp;&amp; solr zk cp /tmp/security.json zk:/security.json -z ${ZK_HOST}&quot;
</code></pre></li>
<li><p>Remove the Solr container.</p>
</li>
<li><p>Update the ZooKeeper password by using the <code>change_zk_password</code> function. The function takes the old password and the new password as arguments. For example:</p>
<pre><code class="lang-bash">change_zk_password &quot;old-password&quot; &quot;new-password&quot;
</code></pre></li>
<li><p>Run the Solr container with the new secrets. For more information about running the Solr container, see <a href="../images-and-containers/solr.html#docker-run-command">Solr</a>.</p>
</li>
</ol>
<h2 id="connectors">Connectors</h2>
<p>If you have any connectors, run the connector containers again with the new secrets.</p>
<h2 id="prometheus-and-grafana">Prometheus and Grafana</h2>
<ol>
<li><p>Run the Prometheus and Grafana containers with the previous secrets that you made a copy of. To do this you can update the <code>docker run</code> command to specify the backup directory for the secrets to mount or update the values in the secret environment variables.</p>
<p> For example, the <code>docker run</code> command for Prometheus might look like:</p>
<pre><code class="lang-bash">docker run -d \
--name &quot;prometheus&quot; \
--net &quot;eia&quot; \
--net-alias &quot;prometheus.eia&quot; \
-p &quot;9090:9090&quot; \
-v &quot;/home/&lt;user-name&gt;/analyze-deployment-tooling/examples/pre-prod/prometheus/web-config.yml:/etc/prometheus/web-config.yml&quot; \
-v &quot;/home/&lt;user-name&gt;/analyze-deployment-tooling/examples/pre-prod/prometheus/prometheus.yml:/etc/prometheus/prometheus.yml&quot; \
-v &quot;prometheus_data:/prometheus&quot; \
-v &quot;/copy-of-secrets/simulated-secret-store/prometheus:/run/secrets&quot; \
&quot;i2group/i2eng-prometheus:2.40&quot;
</code></pre><p> Where the <code>-v &quot;/copy-of-secrets/simulated-secret-store/prometheus:/run/secrets&quot;</code> volume mount is the location of the backed up secrets.</p>
<p> For more information about running the containers, see <a href="../images-and-containers/prometheus.html#docker-run-command">Prometheus</a> and <a href="../images-and-containers/grafana.html#docker-run-command">Grafana</a>.</p>
</li>
<li><p>Update the Grafana password by running the following command:</p>
<pre><code class="lang-bash">docker exec &quot;${GRAFANA_CONTAINER_NAME}&quot; bash -c &quot;grafana-cli admin reset-admin-password ${new_grafana_password}&quot;
</code></pre></li>
<li><p>Remove the Prometheus and Grafana containers.</p>
</li>
<li>Run the Prometheus and Grafana containers with the new secrets. For more information about running the containers, see <a href="../images-and-containers/prometheus.html#docker-run-command">Prometheus</a> and <a href="../images-and-containers/grafana.html#docker-run-command">Grafana</a>.</li>
</ol>
<h2 id="database">Database</h2>
<p>If your deployment pattern uses a database, update the database user passwords.</p>
<ol>
<li><p>For SQL Server:</p>
<ol>
<li><p>Run the SQL Server container with the previous secrets that you made a copy of. To do this you can update the <code>docker run</code> command to specify the backup directory for the secrets to mount or update the values in the secret environment variables.</p>
<p> For example, the <code>docker run</code> command for SQL Server might look like:</p>
<pre><code class="lang-bash">docker run -d \
--name &quot;sqlserver&quot; \
--network &quot;eia&quot; \
--net-alias &quot;sqlserver.eia&quot; \
-p &quot;1433:1433&quot; \
-v &quot;sqlserver_data:/var/opt/mssql&quot; \
-v &quot;sqlserver_sqlbackup:/backup&quot; \
-v &quot;/copy-of-secrets/simulated-secret-store/sqlserver:/run/secrets/&quot; \
-v &quot;/home/&lt;user-name&gt;/analyze-deployment-tooling/prereqs/i2analyze/toolkit/examples/data:/var/i2a-data&quot; \
-e ACCEPT_EULA=&quot;Y&quot; \
-e MSSQL_AGENT_ENABLED=true \
-e MSSQL_PID=&quot;Developer&quot; \
-e SA_PASSWORD_FILE=&quot;/run/secrets/SA_PASSWORD_FILE&quot; \
-e SERVER_SSL=true \
-e SSL_PRIVATE_KEY_FILE=&quot;/run/secrets/server.key&quot; \
-e SSL_CERTIFICATE_FILE=&quot;/run/secrets/server.cer&quot; \
&quot;i2group/i2eng-sqlserver:4.4.4&quot;
</code></pre><p> Where the <code>-v &quot;/copy-of-secrets/simulated-secret-store/sqlserver:/run/secrets&quot;</code> volume mount is the location of the backed up secrets.</p>
<p> For more information about running the container, see <a href="../images-and-containers/sql_server.html#docker-run-command">SQL Server</a>.</p>
</li>
<li><p>Update the passwords for the <code>i2analyze</code>, <code>etl</code>, <code>i2etl</code>, <code>dba</code>, and <code>dbb</code> users by using the <code>change_sql_server_user_password</code> client function. The function takes the username, new password, and <code>sa</code> user&#39;s password as arguments. For example:</p>
<pre><code class="lang-bash">change_sql_server_user_password &quot;username&quot; &quot;new-password&quot; &quot;sa-password&quot;
</code></pre></li>
</ol>
</li>
<li><p>For Postgres:</p>
<ol>
<li><p>Run the Postgres container with the previous secrets that you made a copy of. To do this you can update the <code>docker run</code> command to specify the backup directory for the secrets to mount or update the values in the secret environment variables.</p>
<p> For example, the <code>docker run</code> command for Postgres might look like:</p>
<pre><code class="lang-bash">docker run -d \
--name &quot;postgres&quot; \
--network &quot;eia&quot; \
--net-alias &quot;postgres.eia&quot; \
-p &quot;5432:5432&quot; \
-v &quot;postgres_data:/var/lib/postgresql&quot; \
-v &quot;postgres_sqlbackup:/backup&quot; \
-v &quot;/copy-of-secrets/simulated-secret-store/postgres:/run/secrets/&quot; \
-v &quot;i2a_data_server:/var/i2a-data&quot; \
-e POSTGRES_USER=&quot;postgres&quot; \
-e POSTGRES_PASSWORD=&quot;POSTGRES_PASSWORD&quot; \
-e SERVER_SSL=true \
-e SSL_PRIVATE_KEY_FILE=&quot;/run/secrets/server.key&quot; \
-e SSL_CERTIFICATE_FILE=&quot;/run/secrets/server.cer&quot; \
&quot;i2group/i2eng-postgres:4.4.4&quot;
</code></pre><p> Where the <code>-v &quot;/copy-of-secrets/simulated-secret-store/postgres:/run/secrets&quot;</code> volume mount is the location of the backed up secrets.</p>
<p> For more information about running the container, see <a href="../images-and-containers/postgres_server.html#docker-run-command">Postgres</a>.</p>
</li>
<li><p>Update the passwords for the <code>i2analyze</code>, <code>etl</code>, <code>i2etl</code>, <code>dba</code>, and <code>dbb</code> users by using the <code>change_postgres_server_user_password</code> client function. The function takes the username, new password, and <code>postgres</code> user&#39;s password as arguments.</p>
<p>For example:</p>
<pre><code class="lang-bash">change_postgres_server_user_password &quot;username&quot; &quot;new-password&quot; &quot;postgres-password&quot;
</code></pre></li>
</ol>
</li>
</ol>
<h2 id="liberty">Liberty</h2>
<ol>
<li>Run the Liberty container with the new secrets. For more information, see <a href="../images-and-containers/liberty.html#docker-run-command">Liberty</a>.</li>
</ol>
<h2 id="ha-proxy">HA Proxy</h2>
<ol>
<li>Run the HA Proxy container with the new secrets. For more information, see <a href="../images-and-containers/load_balancer.html#docker-run-command">HA Proxy</a>.</li>
</ol>
<h2 id="what-to-do-next">What to do next</h2>
<p>The system is now deployed with the new secrets. Verify that the system is running as expected.</p>
</article>
          </div>
          
          <div class="hidden-sm col-md-2" role="complementary">
            <div class="sideaffix">
              <nav class="bs-docs-sidebar hidden-print hidden-xs hidden-sm affix" id="affix">
              <!-- <p><a class="back-to-top" href="#top">Back to top</a><p> -->
              </nav>
            </div>
          </div>
        </div>
      </div>
      
      <footer>
        <div class="grad-bottom"></div>
        <div class="footer">
          <div class="container">
            <span class="pull-right">
              <a href="#top">Back to top</a>
            </span>
            
            <span>Generated by <strong>DocFX</strong></span>
          </div>
        </div>
      </footer>
    </div>
    
    <script type="text/javascript" src="../../styles/docfx.vendor.js"></script>
    <script type="text/javascript" src="../../styles/docfx.js"></script>
    <script type="text/javascript" src="../../styles/main.js"></script>
  </body>
</html>
